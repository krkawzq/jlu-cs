# **Prim 语言 词法分析器 (lexer.md)**

## **概述**

本文件描述了 Prim 语言的词法分析器规范，涵盖了所有 token 类型的定义、正则表达式、错误处理机制、以及与解析器 (parser) 的协作。
此版本专注于 **ASCII 支持**、**数字常量表示法**、**标签规则的空格容忍性**、以及 **一元运算符** 的细化。

## **Token 类型**

### **1. 关键字 (Keywords)**

| Token       | 词素       | 说明             |
| ----------- | -------- | -------------- |
| `KW_LET`    | `let`    | 变量声明           |
| `KW_DEL`    | `del`    | 变量删除           |
| `KW_IF`     | `if`     | 条件表达式          |
| `KW_ELSE`   | `else`   | 条件表达式的 else 分支 |
| `KW_LOOP`   | `loop`   | 循环表达式          |
| `KW_BREAK`  | `break`  | 跳出循环           |
| `KW_RETURN` | `return` | 返回语句           |
| `KW_TRUE`   | `true`   | 布尔真值           |
| `KW_FALSE`  | `false`  | 布尔假值           |
| `KW_NULL`   | `null`   | 空值             |

> **注意**：**基本类型**（如 `i32`, `f64`, `str`, `bool` 等）不是关键字，它们在语法分析阶段被视为普通标识符。

### **2. 标识符 (Identifier)**

**Token**: `IDENT`

**正则定义**:

```re2c
A = [A-Za-z_]
AN = [A-Za-z0-9_]
IDENT = A AN*
```

* 标识符必须以字母或下划线开头。
* 后续可以包含字母、数字、下划线。
* 区分大小写。
* 不能是关键字。

**示例**:

```
x, _value, myVar, Counter123, __private
```

### **3. 数字字面量 (Numeric Literals)**

#### **3.1 整数字面量**

| Token     | 前缀        | 基数 | 合法字符        | 示例                  |
| --------- | --------- | -- | ----------- | ------------------- |
| `INT_DEC` | 无         | 10 | `0-9`       | `123`, `1'000'000`  |
| `INT_HEX` | `0x`/`0X` | 16 | `0-9a-fA-F` | `0xFF`, `0x1A'2B`   |
| `INT_OCT` | `0o`/`0O` | 8  | `0-7`       | `0o77`, `0o7'7`     |
| `INT_BIN` | `0b`/`0B` | 2  | `0-1`       | `0b1010`, `0b10'10` |

**注意**：

* 使用单引号 `'` 作为数字分隔符，增强可读性。
* 分隔符只能出现在数字之间，不能在数字开头、结尾或小数点旁边。

**正则定义**:

```re2c
D = [0-9]
HEX = [0-9a-fA-F]
OCT = [0-7]
BIN = [01]
S = [']

DEC_G = D+ ( S D+ )*
HEX_G = HEX+ ( S HEX+ )*
OCT_G = OCT+ ( S OCT+ )*
BIN_G = BIN+ ( S BIN+ )*

INT_DEC = DEC_G
INT_HEX = ("0x" | "0X") HEX_G
INT_OCT = ("0o" | "0O") OCT_G
INT_BIN = ("0b" | "0B") BIN_G
```

#### **3.2 浮点数字面量**

**Token**: `FLOAT_DEC`

支持如下四种形式：

1. `整数.整数`: `3.14`, `1'000.5'00`
2. `整数.`: `42.`, `1'000.`
3. `.整数`: `.5`, `.123`
4. `整数e指数`: `1e10`, `2.5e-3`

**正则定义**:

```re2c
EXP = [eE] [+\-]? DEC_G

FLOAT_DEC = DEC_G "." DEC_G (EXP)?
          | DEC_G "." (EXP)?
          | "." DEC_G (EXP)?
          | DEC_G EXP
```

**示例**:

```
3.14, 1.0, .5, 42., 1e10, 2.5e-3, 1.23e+5
1'000.5'00, 1'000., 1.5e-10
```

#### **3.3 数字字面量错误处理**

**错误类型**：

* `IllegalNumber`
* 错误信息包含 `emsg.pos`：错误位置（相对 token 起始的 0-based 索引）。

以下情况会产生 `IllegalNumber` 错误：

* **前缀后非法字符**：

  * `0x` 后不是十六进制字符: `0xG`
  * `0o` 后不是八进制字符: `0o8`
  * `0b` 后不是二进制字符: `0b2`
* **分隔符误用**：

  * 以分隔符开头: `'123`
  * 连续分隔符: `1''2`
  * 以分隔符结尾: `123'`
* **浮点数错误**：

  * 小数点后非数字: `123.x`
  * 指数后缺数字: `123e`, `123e+`
  * 单独的点后接分隔符: `.'`

### **4. 字符串字面量 (String Literal)**

**Token**: `STRING`

**格式**: 双引号包围的字符序列，支持标准转义符。

**转义符**:

| 转义     | 含义     | 示例                 |
| ------ | ------ | ------------------ |
| `\"`   | 双引号    | `"He said \"Hi\""` |
| `\\`   | 反斜杠    | `"C:\\path"`       |
| `\'`   | 单引号    | `"It\'s"`          |
| `\n`   | 换行符    | `"line1\nline2"`   |
| `\r`   | 回车符    | `"text\r"`         |
| `\t`   | 制表符    | `"a\tb"`           |
| `\0`   | 空字符    | `"null\0term"`     |
| `\xHH` | 十六进制字节 | `"\xFF"`, `"\x41"` |

**错误处理**：

* **未闭合字符串** (`UnterminatedString`)，出现未闭合的 `"` 字符。
* **非法转义** (`IllegalEscape`)，转义符后跟不支持的字符。

**示例**：

```
"hello", "multi\nline", "unicode: \x41", "path: C:\\Users\\Name"
```

### **5. 标签 (Label)**

**Token**: `LABEL`

**格式**: 反引号包围的标识符，空格可以出现在标签内部的任意位置。

**正则定义**:

```re2c
LBL = [A-Za-z0-9_ ]+
LABEL = "`" LBL "`"
```

> **注意**：空格在标签内部可以存在，但标签不能为空或者以非法字符开头。标签以反引号包围，空格可以自由分布。

**示例**:

```
`label`, `outer loop`, `error handler`, `case_1`
```

**非法示例**:

```
``          // 空标签
`123`        // 以数字开头
`label!`     // 包含非法字符
```

### **6. 运算符 (Operators)**

#### **6.1 双字符运算符（优先匹配）**

| Token    | 词素   | 说明   |   |     |
| -------- | ---- | ---- | - | --- |
| `EQEQ`   | `==` | 相等比较 |   |     |
| `NEQ`    | `!=` | 不等比较 |   |     |
| `LE`     | `<=` | 小于等于 |   |     |
| `GE`     | `>=` | 大于等于 |   |     |
| `ANDAND` | `&&` | 逻辑与  |   |     |
| `OROR`   | `    |      | ` | 逻辑或 |

#### **6.2 单字符运算符**

| Token     | 词素  | 说明      |      |
| --------- | --- | ------- | ---- |
| `AMP`     | `&` | 引用运算符   |      |
| `PIPE`    | `   | `       | 类型联合 |
| `BANG`    | `!` | 逻辑非     |      |
| `EQ`      | `=` | 赋值      |      |
| `PLUS`    | `+` | 加法/一元正号 |      |
| `MINUS`   | `-` | 减法/一元负号 |      |
| `STAR`    | `*` | 乘法      |      |
| `SLASH`   | `/` | 除法      |      |
| `PERCENT` | `%` | 取模      |      |
| `LT`      | `<` | 小于      |      |
| `GT`      | `>` | 大于      |      |

#### **一元运算符**

为支持一元运算符（`+a`, `-a`），我们需要明确区分一元与二元运算符的优先级。可以在词法扫描阶段，优先匹配 `+` 或 `-` 紧跟标识符或括号的情况。

---

## **空白符与注释**

### **8. 注释 (Comments)**

#### **8.1 单行注释**

**格式**: `//` 开始，到行尾结束。

**示例**:

```
// 这是单行注释
let x = 42; // 行尾注释
```

#### **8.2 多行注释**

**格式**: `/*` 开始，`*/` 结束。

> 多行注释不支持嵌套。

**示例**:

```
/* 这是
   多行注释 */
let y = /* 内联注释 */ 100;
```

#### **8.3 注释错误**

* **未闭合的注释** (`UnterminatedComment`)
  多行注释没有结束时，抛出此错误。

---

## **错误处理**

### **11. 错误类型**

| ErrKind                 | 说明           | 附加信息                  |
| ----------------------- | ------------ | --------------------- |
| `IllegalChar`           | 非法字符         | `emsg.ch`：字符的 ASCII 码 |
| `UnterminatedString`    | 未闭合字符串       | 无                     |
| `UnterminatedComment`   | 未闭合注释        | 无                     |
| `UnmatchedLeftBracket`  | 未匹配左括号 (EOF) | `emsg.ch`: 括号字符       |
| `UnmatchedRightBracket` | 未匹配右括号       | `emsg.ch`: 括号字符       |
| `IllegalNumber`         | 非法数字         | `emsg.pos`: 错误位置      |
| `IllegalEscape`         | 非法转义         | `emsg.pos`: 转义位置      |
| `IllegalLabel`          | 非法标签         | `emsg.pos`: 错误位置      |
